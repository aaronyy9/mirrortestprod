stages:
  - build
  - deploy

variables:
  HARBOR_REGISTRY: "harbor-prv.zen-x.com.cn"
  HARBOR_REPO_PATH: "bmsdeploy/bms-deploy"
  IMAGE: "$HARBOR_REGISTRY/$HARBOR_REPO_PATH:$CI_COMMIT_SHORT_SHA"
  CONTAINER_NAME: "bms-deploy"
  PORT: "3000"

build:
  stage: build
  tags:
    - prod-23
  script:
    - docker login "$HARBOR_REGISTRY" -u "$HARBOR_USERNAME" -p "$HARBOR_PASSWORD"
    - docker build -t "$IMAGE" .
    - docker push "$IMAGE"
  rules:
    - if: "$CI_COMMIT_BRANCH == 'main'"

deploy:
  stage: deploy
  tags:
    - prod-23
  needs:
    - build
  script:
    - docker login "$HARBOR_REGISTRY" -u "$HARBOR_USERNAME" -p "$HARBOR_PASSWORD"
    - docker pull "$IMAGE"
    - docker rm -f "$CONTAINER_NAME" || true
    - docker run -d --name "$CONTAINER_NAME" --restart always -p ${PORT}:${PORT} -e PORT=${PORT} -e JENKINS_URL="$JENKINS_URL" -e JENKINS_JOB="$JENKINS_JOB" -e JENKINS_USER="$JENKINS_USER" -e JENKINS_TOKEN="$JENKINS_TOKEN" "$IMAGE"
  rules:
    - if: "$CI_COMMIT_BRANCH == 'main'"
      when: manual
      allow_failure: false