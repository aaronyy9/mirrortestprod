stages:
  - build
  - deploy

variables:
  HARBOR_REGISTRY: "harbor-prv.zen-x.com.cn"
  HARBOR_REPO_PATH: "bmsdeploy/bms-deploy"
  IMAGE: "$HARBOR_REGISTRY/$HARBOR_REPO_PATH:$CI_COMMIT_SHORT_SHA"
  CONTAINER_NAME: "bms-deploy"
  PORT: "3000"

build:
  stage: build
  tags:
    - prod-23
  script:
    - docker login "$HARBOR_REGISTRY" -u "$HARBOR_USERNAME" -p "$HARBOR_PASSWORD"
    - docker build -t "$IMAGE" .
    - docker push "$IMAGE"
  rules:
    - if: "$CI_COMMIT_BRANCH == 'main'"

deploy:
  stage: deploy
  tags:
    - prod-23
  needs:
    - build
  script:
    - docker login "$HARBOR_REGISTRY" -u "$HARBOR_USERNAME" -p "$HARBOR_PASSWORD"
    - docker pull "$IMAGE"
    - docker rm -f "$CONTAINER_NAME" || true
    - |
      ENV_OPTS=""
      if [ -n "$ENV_FILE_PATH" ] && [ -f "$ENV_FILE_PATH" ]; then
        ENV_OPTS="--env-file $ENV_FILE_PATH"
      else
        [ -n "$JENKINS_URL" ] && ENV_OPTS="$ENV_OPTS -e JENKINS_URL=$JENKINS_URL"
        [ -n "$JENKINS_JOB" ] && ENV_OPTS="$ENV_OPTS -e JENKINS_JOB=$JENKINS_JOB"
        [ -n "$JENKINS_USER" ] && ENV_OPTS="$ENV_OPTS -e JENKINS_USER=$JENKINS_USER"
        [ -n "$JENKINS_TOKEN" ] && ENV_OPTS="$ENV_OPTS -e JENKINS_TOKEN=$JENKINS_TOKEN"
      fi
      docker run -d --name "$CONTAINER_NAME" --restart always -p ${PORT}:${PORT} -e PORT=${PORT} $ENV_OPTS "$IMAGE"
  rules:
    - if: "$CI_COMMIT_BRANCH == 'main'"
