stages:
  - build
  - deploy

variables:
  HARBOR_REGISTRY: "harbor-prv.zen-x.com.cn"
  HARBOR_REPO_PATH: "bmsdeploy/bms-deploy"
  CONTAINER_NAME: "bms-deploy"
  PORT: "3000"
  RELEASE_SCOPE: "patch"
  ENABLE_PUSH_TAG: "0"

build:
  stage: build
  tags:
    - prod-23
  script:
    - set -e
    - git fetch --tags --force || true
    - |
      LATEST=$(git tag --list "v*" | sort -V | tail -n 1 || true)
      echo "Latest tag: $LATEST"
      echo "RELEASE_SCOPE: $RELEASE_SCOPE"
      if [ -z "$LATEST" ]; then
        NEXT_VERSION="v1.0.0"
      else
        MAJOR=$(echo "$LATEST" | sed 's/^v//' | cut -d. -f1)
        MINOR=$(echo "$LATEST" | sed 's/^v//' | cut -d. -f2)
        PATCH=$(echo "$LATEST" | sed 's/^v//' | cut -d. -f3)
        case "$RELEASE_SCOPE" in
          major) NEXT_VERSION="v$((MAJOR+1)).0.0" ;;
          minor) NEXT_VERSION="v${MAJOR}.$((MINOR+1)).0" ;;
          *) NEXT_VERSION="v${MAJOR}.${MINOR}.$((PATCH+1))" ;;
        esac
      fi
      echo "NEXT_VERSION: $NEXT_VERSION"
      echo "GITLAB_API_TOKEN set?: $( [ -n "$GITLAB_API_TOKEN" ] && echo yes || echo no )"
    - DATE_TAG="$(date +%Y%m%d)-${CI_COMMIT_SHORT_SHA}"
    - echo "$NEXT_VERSION" > version.txt
    - docker login "$HARBOR_REGISTRY" -u "$HARBOR_USERNAME" -p "$HARBOR_PASSWORD"
    - docker build -t "$HARBOR_REGISTRY/$HARBOR_REPO_PATH:$NEXT_VERSION" -t "$HARBOR_REGISTRY/$HARBOR_REPO_PATH:$DATE_TAG" .
    - docker push "$HARBOR_REGISTRY/$HARBOR_REPO_PATH:$NEXT_VERSION"
    - docker push "$HARBOR_REGISTRY/$HARBOR_REPO_PATH:$DATE_TAG"
    - |
      if [ -n "$GITLAB_API_TOKEN" ]; then
        set +e
        curl --fail -s --header "PRIVATE-TOKEN: $GITLAB_API_TOKEN" \
          --data "tag_name=$NEXT_VERSION&ref=$CI_COMMIT_SHA" \
          "$CI_API_V4_URL/projects/$CI_PROJECT_ID/repository/tags"
        RC=$?
        set -e
        if [ $RC -ne 0 ]; then
          echo "API tag creation failed (code $RC), attempting git push fallback"
          if [ "$ENABLE_PUSH_TAG" = "1" ] && [ -n "$CI_JOB_TOKEN" ]; then
            git config user.name "gitlab-ci"
            git config user.email "ci@example.local"
            git remote set-url origin "https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
            git tag -a "$NEXT_VERSION" -m "release $NEXT_VERSION" || true
            git push origin "$NEXT_VERSION" || true
          else
            echo "Fallback disabled or CI_JOB_TOKEN missing; skipping git tag push"
          fi
        else
          echo "API tag created: $NEXT_VERSION"
        fi
      else
        echo "GITLAB_API_TOKEN not set; using fallback if enabled"
        if [ "$ENABLE_PUSH_TAG" = "1" ] && [ -n "$CI_JOB_TOKEN" ]; then
          git config user.name "gitlab-ci"
          git config user.email "ci@example.local"
          git remote set-url origin "https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
          git tag -a "$NEXT_VERSION" -m "release $NEXT_VERSION" || true
          git push origin "$NEXT_VERSION" || true
        fi
      fi
  artifacts:
    paths:
      - version.txt
    expire_in: 7 days
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $RELEASE_SCOPE == "major"'
      when: manual
      allow_failure: false
    - if: '$CI_COMMIT_BRANCH == "main"'

deploy:
  stage: deploy
  tags:
    - prod-23
  needs:
    - build
  script:
    - set -e
    - NEXT_VERSION=$(cat version.txt)
    - docker login "$HARBOR_REGISTRY" -u "$HARBOR_USERNAME" -p "$HARBOR_PASSWORD"
    - docker pull "$HARBOR_REGISTRY/$HARBOR_REPO_PATH:$NEXT_VERSION"
    - docker rm -f "$CONTAINER_NAME" || true
    - |
      ENV_OPTS=""
      if [ -n "$ENV_FILE_PATH" ] && [ -f "$ENV_FILE_PATH" ]; then
        ENV_OPTS="--env-file $ENV_FILE_PATH"
      else
        [ -n "$JENKINS_URL" ] && ENV_OPTS="$ENV_OPTS -e JENKINS_URL=$JENKINS_URL"
        [ -n "$JENKINS_JOB" ] && ENV_OPTS="$ENV_OPTS -e JENKINS_JOB=$JENKINS_JOB"
        [ -n "$JENKINS_USER" ] && ENV_OPTS="$ENV_OPTS -e JENKINS_USER=$JENKINS_USER"
        [ -n "$JENKINS_TOKEN" ] && ENV_OPTS="$ENV_OPTS -e JENKINS_TOKEN=$JENKINS_TOKEN"
      fi
      docker run -d --name "$CONTAINER_NAME" --restart always -p ${PORT}:${PORT} -e PORT=${PORT} $ENV_OPTS "$HARBOR_REGISTRY/$HARBOR_REPO_PATH:$NEXT_VERSION"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
